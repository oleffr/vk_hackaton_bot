FROM python:3.11-slim

# Устанавливаем системные зависимости (включая поддержку PDF)
RUN apt-get update && apt-get install -y \
    build-essential \
    cmake \
    git \
    poppler-utils \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Копируем зависимости и устанавливаем их
COPY requirements.txt .
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# Устанавливаем FAISS
RUN pip install --no-cache-dir faiss-cpu

# Копируем весь проект
COPY . .

# Создаем необходимые директории
RUN mkdir -p /app/kb_output

# Указываем переменные окружения для Ollama
ENV LM_API_URL=http://ollama:11434/v1
ENV LM_API_KEY=not-needed
ENV LLM_MODEL_NAME=qwen2.5:3b
ENV EMBEDDING_MODEL_NAME=all-minilm

# Команда по умолчанию - create base from json
CMD ["python", "main.py", "json", "--json_dir", "./jsons", "--out", "./kb_output"]
